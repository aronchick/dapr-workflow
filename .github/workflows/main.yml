name: main

on:
  push:
    branches: [ main ]
  # workflow_dispatch:
  #   inputs:
  #     tags:
  #       description: 'Workflow Dispatched'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  workflow_run:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
    
    - name: hack python
      run: |
        # Hack to get setup-python to work on act
        if [ ! -f "/etc/lsb-release" ] ; then
          echo "DISTRIB_RELEASE=18.04" > /etc/lsb-release
        fi

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.7.9'

    - name: Install dependencies
      run: python3 -m pip install --upgrade pip setuptools wheel

    - name: Setup Environment
      id: setup_environment
      run: |
        python3 -m pip install -r requirements.txt
        ./setup_dapr.sh

    # - name: Start SSH via Ngrok
    #   run: |
    #     ./setup_ngrok.sh
    #     sleep 1h
    #   env:
    #     # After sign up on the https://ngrok.com/
    #     # You can find this token here: https://dashboard.ngrok.com/get-started/setup
    #     NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
    #     USER_PASS: ${{ secrets.USER_PASS }}
    #     COMPONENT_AZUREKEYVAULT: ${{ secrets.COMPONENT_AZUREKEYVAULT }}

    - name: Create Components
      id: create_components
      run: |
        python3 export_secrets_to_components.py
      env:
        COMPONENT_AZUREKEYVAULT: ${{ secrets.COMPONENT_AZUREKEYVAULT }}

    - name: Cache Installation
      uses: actions/cache@v2
      env:
        cache-name: cache-installation
      with:
        path: ~/.local
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-

    - name: Debugging with tmate
      # You may pin to the exact commit or the version.
      # uses: mxschmitt/action-tmate@db65d6e9a5d44586bafd05807eef6e82d0a2e86c
      uses: mxschmitt/action-tmate@v3

    - name: Step 1
      id: step_1
      run: dapr run --app-id python-subscriber -d ~/.dapr/components python3 step_1.py
